//#####################################################################################
// 전역
//#####################################################################################

var global = {};
/**
* @ 스크롤바를 사용자 스타일로 변환한다.
* param1 : <Selector> id or class selector
* param2 : <Sring> type
* ex)global.fn_customerScrollBarInit(id)
*/

//customer scroll
global.fn_customerScrollBarInit = function(id, type, callbacksOption){
  id.mCustomScrollbar({
    theme : type,
    live : false,
    scrollInertia : 0,
    alwaysShowScrollbar: 1,
    mouseWheel : {
      enable : true,
      axis : "y",
      scrollAmount : 45
      // preventDefault : false,
      // deltaFactor : "auto",
      // normalizeDelta : false,
      // invert : false,
      // disableOver : ["select","option","keygen","datalist","textarea"]
    },
    advanced:{
      autoScrollOnFocus: false,
      updateOnContentResize: true
    },
    callbacks : callbacksOption
  });
};
global.fn_heightResizing = function(target){
  $(target).css({'height':($(document).height())+'px'});
  $(window).resize(function(){
    $(target).css({'height':($(document).height())+'px'});
  });
};

global.fn_setTop = function(targetElement){
  setTimeout(function(){
    targetElement.mCustomScrollbar('scrollTo',"2");
    // targetElement.mCustomScrollbar('scrollTo',"top");
  }, 10);
};

/*
* @ inputbox width리사이징을 위한 function
* param1 : <Event> selector
* ex)global.inputResizing(e.target)
*/
global.fn_inputResizing = function(target){
  $('body').append('<span class="new_width">'+$(target).val()+'</span>');
  var textWidth = $('.new_width').width();
  $(target).width(textWidth);
  $('.new_width').remove();
};

/*
* @ textarea height 리사이징을 위한 function
* param1 : <Event> selector
* ex)global.fn_textareaResizing(e.target)
*/
global.fn_textareaResizing = function(target){
  var tagetWidth = $(target).width()+45;
  $('body').append('<div class="new_height" style="position:absolute; top:0; width:'+tagetWidth+'px; min-height:26px; padding-right:48px; line-height:26px;">'+$(target).val()+'</div>');
  var textHeight = $('.new_height').height() - 1;
  $(target).height(textHeight);
  $('.new_height').remove();
};
/*
* @ timeline textarea height 리사이징을 위한 function
* param1 : <Event> selector
* ex)global.fn_timeLineInputResizing(e.target)
*/
global.fn_timeLineInputResizing = function(target){
  $('body').append('<div class="new_timeline" style="position:absolute; top:0; min-width:40px; max-width:200px; min-height:17px; line-height:20px;">'+$(target).val()+'</div>');
  var textWidth = $('.new_timeline').width()+8;
  var textHeight = $('.new_timeline').height();
  $(target).width(textWidth);
  $(target).height(textHeight);
  $('.new_timeline').remove();
};

/*
* @ 현재 다른 사용자의 페이지를 방문중이지 확인
* param1 : <String> selector
* return : <boolen>
* ex)global.fn_checkPageOwner('testUser');
*/
global.fn_checkPageOwner = function(userId){
  if(_.isEqual(userId, global.login.userId)){
    return true;
  }
  else {
    return false;
  }
};

/*
* @ 다른 사용자 페이지 방문 시 pageOwner값 설정
* param1 : <String> selector
* ex)global.fn_setPageOwner('testUser');
*/
global.fn_setPageOwner = function(userId){
  global.login.pageOwner = userId;
};

/*
* @ custom select function
* param1 : <Event> selector
* param2 : <String> type class
* ex)global.fn_selectPicker('.selectpicker', 'btn-info', '100px')
*/
global.fn_selectPicker = function(_target, _type){
  $(_target).selectpicker({
    style: _type
  });
};


/*
* @ custom select function
* param1 : <Event> selector
* param2 : <String> type class
* ex)global.fn_selectPicker('.selectpicker', 'btn-info', '100px')
*/
global.fn_tableParse = function(){
  var rowWidth = $('.tr:first').width();
  var colWidth = $('.td:first').width();
  var marginRight = colWidth - rowWidth + 20;
  $('.td.colspan').css('margin-right', marginRight + 'px').show();
};

/*
* @ 항목이 값을 갖고 있는지 확인
* param1 : <object> selector
* ex)global.fn_isExist(object);
*/
global.fn_isExist = function(target) {
  if(target){
    var type = Object.prototype.toString.call(target);
    switch(type){
      case "[object Object]":
      //빈 object?
      if(Object.getOwnPropertyNames(target).length === 0){
        return false;
      }else{
        return true;
      }
      break;
      case "[object Array]":
      //빈 array???
      if(target.length === 0){
        return false;
      }else{
        for(var i in target ){
          if(target[i]){
            if(Object.prototype.toString.call(target[i])==="[object Object]" && Object.getOwnPropertyNames(target).length === 0){
              return false;
            }
            return true;
          }
        }
        return false;
      }
      break;
      default:
      return true;
    }
  } else {
    return false;
  }
};

global.fn_getName = function(userId) {
  var userInfo = Meteor.users.find({username: userId}).fetch()[0];
  if (userInfo) {
    return userInfo.profile.name;
  } else {
    return userId;
  }
};


global.fn_getNickName = function(userId) {
  if (!userId) {
    userId = global.login.userId;
  }
  var userInfo = Meteor.users.find({username: userId}).fetch()[0];
  if (userInfo) {
    return userInfo.profile.nickName;
  }else{
    return userId;
  }
};


global.fn_getUsersIdByNick = function(nickName) {
  var result = [];
  var regexNickName = new RegExp(["^.*", nickName, ".*"].join(""), "gi");
  var usersInfo = Meteor.users.find({'profile.nickName': regexNickName}).fetch();
  _.each(usersInfo, function(info){
    result.push(info.username);
  });

  return result;
};

global.fn_getEmail = function(userId) {
  if (!userId) {
    userId = global.login.userId;
  }
  var userInfo = ReactiveMethod.call('getUserInfo', userId, ['profile.email']);
  if (userInfo) {
    return userInfo[0].profile.email;
  }
};

//
global.fn_getUserInfo = function(userId) {
  var userInfo = Meteor.users.find({username: userId}).fetch()[0];
  if (userInfo) {
    return userInfo.profile;
  }
};

global.fn_setLoginId = function(userId){
  global.login.userId = userId;
  global.login.pageOwner = userId;
};

global.fn_setLoginAuth = function(author){
  if(author){
    global.login.authority = author;
  }else{
    global.login.authority = 'user';
  }

};

//이미지 사이즈별 스트링 만들기
global.fn_makeImageString = function(imagePath, type) {
  var result = '';
  if(type){
    if(imagePath.indexOf('_originRe') > -1){
      result = imagePath.substring(0, imagePath.lastIndexOf('_originRe'))+ '_' + type + imagePath.substring(imagePath.lastIndexOf('.'));
    }
    else if (imagePath.indexOf('_thumb') > -1) {
      result = imagePath.substring(0, imagePath.lastIndexOf('_thumb'))+ '_' + type + imagePath.substring(imagePath.lastIndexOf('.'));
    } else {
      result = imagePath.substring(0, imagePath.lastIndexOf('.'))+ '_' + type + imagePath.substring(imagePath.lastIndexOf('.'));
    }
  } else {
    result = imagePath;
  }
  return result;
};

//프로필 이미지 스트링 만들기 by userId(type : thumb, originRe)
global.fn_getUsersProfileImageString = function(userId, type) {
  var result = '';
  var userInfo = Meteor.users.find({username: userId},{fields:{'profile.profileImg':1}}).fetch()[0];
  if(userInfo && userInfo.profile.profileImg){
    var profileImg = userInfo.profile.profileImg;
    if(type){
      result = global.s3.bucketPath + profileImg.substring(0, profileImg.lastIndexOf('.'))+ '_' + type + profileImg.substring(profileImg.lastIndexOf('.'));
    } else {
      result = global.s3.bucketPath + profileImg;
    }
  }
  return result;
};

//프로필 이미지 스트링 만들기 by profilePath (type : thumb, originRe)
global.fn_makeProfileImgString = function(_profilePath, _type) {
  var result = '';
  if(_profilePath){
    if(_type){
      result = global.s3.bucketPath + _profilePath.substring(0, _profilePath.lastIndexOf('.'))+ '_' + _type + _profilePath.substring(_profilePath.lastIndexOf('.'));
    } else {
      result = global.s3.bucketPath + _profilePath;
    }
  }
  return result;
};

global.fn_setS3UploadInfo = function(folderPath){
  var editorUploadInfo = global.utilFroalaUpload(folderPath);
  global.editorSettings.imageUploadToS3 = {
    bucket: global.s3.bucketName,
    region: global.s3.region, //'s3-website-us-east-1', //us-east-1
    keyStart: folderPath + '/',
    callback: function (url, key) {
    },
    params: {
      'acl': 'public-read',
      'policy': editorUploadInfo.s3Policy,
      'x-amz-signature': editorUploadInfo.s3Signature,
      'x-amz-algorithm': 'AWS4-HMAC-SHA256',
      'x-amz-credential': editorUploadInfo.s3Credentials,
      'x-amz-date': editorUploadInfo.s3Date
    }
  };
};

global.fn_deleteS3Img = function(arg){
  var s3Bucket = new AWS.S3();
  if(arg.Key.split("iml-images/")[1]){
    arg.Key = arg.Key.split("iml-images/")[1];
  }else{
    arg.Key = arg.Key.split("iml-images/")[0];
  }

  s3Bucket.deleteObject(arg, function (err, data) {
    if (err) {
      console.log("Check if you have sufficient permissions : "+err);
    }
  });
};

//imagethum -> originRe 변경
global.fn_chagneImageType = function(path){
  path = path.replace("_thumb.","_originRe.");
  return path;
};

//s3에 있는 이미지를 삭제하는 함수
//params : removeImageList ( type : array )
global.fn_DeleteS3Images = function(removeImageList) {
  var bucketName = S3.config.bucket;
  var params = {};
  if(!_.isEmpty(removeImageList[0])){
    _.each(removeImageList, function(image){
      var enUrl = image.path ? image.path.replace(/\+/gi, ' ') : image.replace(/\+/gi, ' '); // '+' to ' '(space)

      var decodeUrl = decodeURIComponent(enUrl);  //url decode  예) console.log('decode', decodeURIComponent($(img[0]).attr("src")));
      var path = decodeUrl.replace(global.s3.bucketPath,''); //decodeUrl; //bucketName/ 이후부터 잘라서 넣는부분

      params = {
        Bucket: bucketName,
        Key: path
      };


      if(params.Key.indexOf('_originRe') >= 0){
        //1. originRe 지우기
        global.fn_deleteS3Img(params);
        //2. thumbnail 지우기
        params.Key = params.Key.replace('_originRe', '_thumb');
        global.fn_deleteS3Img(params);
        //3. 원본 지우기
        params.Key = params.Key.replace('_thumb', '');
        global.fn_deleteS3Img(params);
      } else {
        //1. origin 지우기
        global.fn_deleteS3Img(params);
        //2. originRe 지우기
        params.Key = params.Key.split('.jpeg')[0] + '_originRe.jpeg';
        global.fn_deleteS3Img(params);
        //3. thumb 지우기
        params.Key = params.Key.replace('_originRe', '_thumb');
        global.fn_deleteS3Img(params);
      }
    });
  }
};

//s3에 있는 이미지를 삭제하는 함수
//params : removeImageList ( type : array )
global.fn_DeleteS3ImagesByType = function(removeImageList, fromType) {
  var bucketName = S3.config.bucket;
  var params = {};

  if(!_.isEmpty(removeImageList[0])){
    _.each(removeImageList, function(imageData){
      var image = imageData.path ? imageData.path : imageData;
      Meteor.call('isNotThereUsedFile', image, fromType, function(error, result) {
        if(error){
          console.error(error);
        } else {
          if(result){
            // var enUrl = image.path.replace(/\+/gi, ' '); // '+' to ' '(space)
            var enUrl = image.replace(/\+/gi, ' '); // '+' to ' '(space)
            var decodeUrl = decodeURIComponent(enUrl);  //url decode  예) console.log('decode', decodeURIComponent($(img[0]).attr("src")));
            var path = decodeUrl.replace(global.s3.bucketPath,''); //decodeUrl; //bucketName/ 이후부터 잘라서 넣는부분

            params = {
              Bucket: bucketName,
              Key: path
            };

            //1. originRe 지우기
            global.fn_deleteS3Img(params);
            //2. thumbnail 지우기
            params.Key = params.Key.replace('_originRe', '_thumb');
            global.fn_deleteS3Img(params);
            //3. 원본 지우기
            params.Key = params.Key.replace('_thumb', '');
            global.fn_deleteS3Img(params);
          }
        }
      });
    });
  }
};

// 유저닉네임 여러명 가져오기
global.fn_groupMemberNickName = function(userId, groupMember) {
  var result = '';
  var userInfo = Meteor.users.find({username: userId}).fetch()[0];
  if(userInfo){
    result = userInfo.profile.nickName;

    var message = '';
    if (groupMember.length > 1) {
      message = ' 외 ' + (groupMember.length - 1) + '명';
    }
    return result + message;
  }
  return result;
};

global.fn_numPad = function(n, width){
  n = n + '';
  return n.length >= width ? n : new Array(width - n.length + 1).join('0') + n;
};


global.fn_diffDateTime = function(endDateTime){
  var result = {};
  var startTime = new Date(global.utilGetDate().default); // 시작일시 ('2009-01-01 12:30:00')
  var endTime  = new Date(global.utilGetDate(endDateTime).default);    // 종료일시 ('2009-10-01 17:20:10')

  // 두 일자(startTime, endTime) 사이의 차이를 구한다.
  var dateGap = endTime.getTime() - startTime.getTime();
  var timeGap = new Date(0, 0, 0, 0, 0, 0, endTime - startTime);

  // 두 일자(startTime, endTime) 사이의 간격을 "일-시간-분"으로 표시한다.

  result = {
    diffDay  : global.fn_numPad(Math.floor(dateGap / (1000 * 60 * 60 * 24)), 1), // 일수
    diffHour : timeGap.getHours(),       // 시간
    diffMin  : timeGap.getMinutes(),      // 분
    diffSec  : timeGap.getSeconds(),      // 초
  };

  return result;
};

global.fn_diffDate = function(eDate){
  var result = {};
  var toDay = new Date(global.utilGetDate().default);//new Date(); // 시작일시 ('2009-01-01')
  var startDate = new Date(toDay.getFullYear(), toDay.getMonth(), toDay.getDate());
  var endDate  = new Date(global.utilGetDate(eDate).defaultYMD);    // 종료일시 ('2009-10-01')
  var flag = '-';

  // 두 일자(startTime, endTime) 사이의 차이를 구한다.
  var dateGap = endDate.getTime() - startDate.getTime();
  dateGap = Math.floor(dateGap / (1000 * 60 * 60 * 24));

  if(dateGap < 0){
    dateGap = dateGap.toString().substring(1);
    flag = '+';
  } else if( dateGap === 0){
    dateGap = 'day';
  } else {
    dateGap = dateGap.toString();
  }

  result = {
    diffDay  : global.fn_numPad(dateGap, 1), // 일수
    flag : flag
  };

  return result;
};

global.fn_concat_imageString_type = function(imagePath, type){
  var result = '';
  result = imagePath.substring(0, imagePath.lastIndexOf('.'))+ '_' + type + imagePath.substring(imagePath.lastIndexOf('.'));
  return result;
};

global.fn_isPassAway = function(userId){
  if(Meteor.users.findOne({username:userId})){
    return Meteor.users.findOne({username:userId}).profile.isPassAway;
  } else {
    return false;
  }
};

//조사선택 함수
global.fn_getTextPostPosition = function(context, type){
  //typeA : 을/를 구분, typeB : 이/가 구분, typeC : 으로/로 구분, typeD : 은/는 구분
  var result = '';
  if(global.fn_isHangul(context)){

    var lastText = context.charAt(context.length - 1);
    var textCode = lastText.charCodeAt(0);
    var batchim = true;
    if((textCode-44032)%28 === 0) {
      batchim = false;
    }
    switch(type) {
      case 'typeA': result = (batchim) ? '을':'를'; break;
      case 'typeB': result = (batchim) ? '이':'가'; break;
      case 'typeC': result = (batchim) ? '으로':'로'; break;
      case 'typeD': result = (batchim) ? '은':'는'; break;
    }
  } else {
    result = _.isEqual(type, 'typeA') ? '는/를' : '가';
  }

  return result;
};

global.fn_isHangul = function(context){
  var c = context.charCodeAt(0);
  if( 0x1100<=c && c<=0x11FF ) return true;
  if( 0x3130<=c && c<=0x318F ) return true;
  if( 0xAC00<=c && c<=0xD7A3 ) return true;
  return false;
};

global.fn_sendEmail = function(type, email, title, conText, fromEmail){
  var emailInfo = {};
  emailInfo = emailSend = {
    to: email,
    from: '잇츠마이스토리 <support@itsmystory.com>',
    subject: title,
    text: conText
  };

  // if(type === 'cert') {
  //   emailInfo.from = '더푸르츠 인증 <noreply@itsmystory.com>';
  // } else if('invite'){
  //   emailInfo.from = fromEmail;
  // } else {
  //   emailInfo.from = '잇츠마이스토리 <support@itsmystory.com>';
  // }

  return emailInfo;
};

global.fn_getDifferenceData =  function(arrayTarget, arrSource){
  // 두개의 ArrayData를 비교하여 target에 있는 다른 데이터만 Array로 반환
  var resultTarget = _.reject(arrayTarget, function(obj){ return _.findWhere(arrSource, obj); });
  return resultTarget;
};

//target이 source보다 크면 true
global.fn_isGreaterThan = function(target, source){
  return target > source;
};

//target이 source보다 작으면 true
global.fn_isLessThan = function(target, source){
  return target < source;
};

//2개값 덧셈
global.fn_sumation = function(param1, param2){
  return Number(param1) + Number(param2);
};

//2개값 뺄셈
global.fn_subtraction = function(_param1, _param2){
  var param1 = _param1 ? _param1 : 0;
  var param2 = _param2 ? _param2 : 0;
  return Number(param1) - Number(param2);
};

global.fn_rotateImage = function(orientation){
  var deg = 0;
  switch (orientation) {
    case 2: //확인필요
    deg = 90;
    break;
    case 3:
    deg = 180;
    break;
    case 4: //확인필요
    deg = 180;
    break;
    case 5: //확인필요
    deg = 90;
    break;
    case 6:
    deg = 90;
    break;
    case 7: //확인필요
    deg = 90;
    break;
    case 8:
    deg = 270;
    break;
    default: deg = 0;
  }
  return deg;
};

global.fn_upLoadeS3Image = function(imgInfo, folderName){
  var imgsInfo = [];
  if(_.isArray(imgInfo)){
    imgsInfo = imgInfo;
  } else {
    imgsInfo.push(imgInfo);
  }

  _.each(imgsInfo, function(item){
    var realPath = item.data.substring(item.data.indexOf("data"));

    var path = '';
    if(item.type){
      path = folderName +'/' + item.fileName + '_'+ item.type +'.' + item.extension;
    } else {
      path = folderName +'/' + item.fileName + '.' + item.extension;
    }

    var s3Bucket = new AWS.S3();

    var buf = new Buffer(realPath.replace(/^data:image\/\w+;base64,/, ""),'base64');
    var data = {
      Bucket: S3.config.bucket,
      Key: path,
      Body: buf,
      ContentEncoding: 'base64',
      ContentType: 'image/jpeg'
    };
    //위에서 설정한 파일명과, 서버정보를 이용하여, DB에 데이터를 저장한다.
    s3Bucket.putObject(data, function(err, data){
      if (err) {
        console.log(err);
        console.log('Error uploading data: ', data);
      } else {
        console.log('succesfully uploaded the image!',data);
      }
    });
  });
};

global.toDecimal = function (number) {
  return number[0].numerator + number[1].numerator /
  (60 * number[1].denominator) + number[2].numerator / (3600 * number[2].denominator);
};

/*
* @ scroll시 head 메뉴 영역을 변경하기 위한 function
* ex) global.tranceHeadMenu
*/
global.tranceHeadMenu = function(){
  if(this.mcs.top < -30){
    $('.timeline-menuContainer').addClass('scrolling');
    $('.timeline_header').slideUp();
    $('.timeline-qna').slideUp();
    $('.timeline-filter').addClass('scrolling');
    $('.content.left').css({'padding-bottom':'65px', 'margin-bottom':'-65px' } );
    $('.logo-slogun').hide();
    $('.gnb').addClass('scrolling');
    $('#gnbList').hide();
  }else{
    $('.timeline-menuContainer').removeClass('scrolling');
    $('.timeline_header').slideDown();
    $('.timeline-qna').slideDown();
    $('.timeline-filter').removeClass('scrolling');
    $('.content.left').css( {'padding-bottom':'145px', 'margin-bottom':'-145px' } );
    $('.logo-slogun').show();
    $('.gnb').removeClass('scrolling');
    $('#gnbList').show();
  }
};

/*
* @ lifemap detail 이동 function()
* requestTemplate = {postId: 'string', type: 'BS','TC'....}
*/
global.fn_replaceLifeViewDetail = function(requestTemplate, pageType){
  var templateData = {};
  var sessionName = 'endingNoteList templateData';
  var parentViewId = '';
  if (pageType === 'ihLifeView') {
    sessionName = 'ihLifeView templateData';
    parentViewId = 'inheritanceContents';
  }
  if(requestTemplate.type == 'BS'){
    var requestData = [];
    requestData.push(requestTemplate);
    Meteor.call('getClickedImgDatas',requestData, function(error, result){
      if(error){
        console.error(error);
      }
      if(result){
        if(result.length === 1){  //BS일경우
          templateData.headerTmp = 'endingNoteListHeaderBucketList';
          templateData.contentTmp = 'bucketDetail';
          templateData.data = {
            _id : result[0].postId,
            subId : result[0]._id
          };
        }
        console.log("getClick",result);
        templateData.data.lifeViewDataList = requestTemplate.lifeViewDataList;
        templateData.data.lifeViewOriginData = requestTemplate.lifeViewOriginData;
        templateData.data.fromView = requestTemplate.fromView;
        templateData.data.parentViewId = parentViewId;
        Session.set(sessionName, null);
        setTimeout(function(){
          Session.set(sessionName, templateData);
        }, 100);
      }
    });
  }else{
    var _id = requestTemplate.postId;
    templateData.contentTmp = 'imDetail';
    templateData.data = {
      _id : _id,
    };
    switch(requestTemplate.type){
      case 'IM':
      templateData.headerTmp = 'endingNoteListHeaderIm';
      templateData.contentTmp = 'imDetail';
      break;
      case 'BL':
      templateData.headerTmp = 'endingNoteListHeaderBucketList';
      templateData.contentTmp = 'bucketDetail';
      break;
      case 'TC':
      templateData.headerTmp = 'endingNoteListHeaderTimeCapsule';
      templateData.contentTmp = 'timeCapsuleDetail';
      break;
    }
    templateData.data.lifeViewDataList = requestTemplate.lifeViewDataList;
    templateData.data.lifeViewOriginData = requestTemplate.lifeViewOriginData;
    templateData.data.fromView = requestTemplate.fromView;
    templateData.data.parentViewId = parentViewId;

    Session.set(sessionName, null);
    setTimeout(function(){
      Session.set(sessionName, templateData);
    }, 100);
  }

};

global.fn_getBirthDay = function(userId){
  var result = '';
  var userInfo = Meteor.users.find({username: userId}).fetch()[0];
  if (userInfo) {
    return userInfo.profile.birthday.date ? userInfo.profile.birthday.date : undefined;
  }
};

global.fn_getCalDate = function(_date, _day, _type){
  var date = new Date(_date);
  switch(_type){
    case 'SUM' : //더하기
    date.setDate(date.getDate() + _day);
    break;
    case 'SUB' : //빼기
    date.setDate(date.getDate() - _day);
    break;
  }
  return date.toISOString();
};

global.fn_getCalDateByMonth = function(_date, _month, _type){
  var date = new Date(_date);
  switch(_type){
    case 'SUM' : //더하기
    date.setMonth(date.getMonth() + _month);
    break;
    case 'SUB' : //빼기
    date.setMonth(date.getMonth() - _month);
    break;
  }
  return date.toISOString();
};

global.fn_getCalDateByYear = function(_date, _year, _type){
  var date = new Date(_date);
  switch(_type){
    case 'SUM' : //더하기
    date.setYear(date.getFullYear() + _year);
    break;
    case 'SUB' : //빼기
    date.setYear(date.getFullYear() - _year);
    break;
  }
  return date.toISOString();
};
//대문자 만들기
global.fn_toUpperCase = function(_string){
  var result = _string.toUpperCase();
  return result;
};

//소문자만들기
global.fn_toLowerCase = function(_string){
  var result = _string.toLowerCase();
  return result;
};

//인덱스 이용해서 문장, 글자 일부발최하기
global.fn_getSubstring = function(_string, _startIndex, _count){
  var result = _string.substring(_startIndex,_count);
  return result;
};
// 엔터값 <br/>로 전환
global.fn_enter = function(content) {
  if (content) {
    var str = content.replace(new RegExp('\n','g'), "<br/>");
    return str;
  }
};

global.fn_listHeightResize = function(ids){
  var eHeight = 70;
  var eDefault = 50;
  var ePadding = 20;
  $(ids).each(function(i){
    var qObj = $(this).find('.timeline-question');
    var aObj = $(this).find('.timeline-answer');
    var qHeight = qObj.height();
    var aHeight = aObj.height();
    var tHeight = 0;
    if( qHeight !== null && qHeight >= aHeight){
      tHeight = qHeight + ePadding;
      $(this).height(tHeight);
    }else if(aHeight !== null && aHeight >= qHeight){
      tHeight = aHeight + ePadding;
      $(this).height(tHeight);
    }else{
      tHeight = eDefault + ePadding;
      $(this).height(tHeight);
    }
  });
};

//###################################################################################################################################
//###################################################### CODE & DEFAULT DATA ########################################################
//###################################################################################################################################
//
// // 추가할 리스트 갯수 정보
// global.itemsIncrement = 10; //defualt 10
// global.timeLineItemsIncrement = 5; //defualt 5
// global.commentIncrement = 5;
//
// global.join = {
//   aggrement: {},
//   membership: {},
//   profile:{}
// };
//
// //로그인한 사용자 정보
global.login = {
  userId : '', // 로그인 UserId
  nickName : '', // test용 별명
  pageOwner : '', // 페이지 권한(내 페이지와, 다른사람의 페이지 구분)
  authority : ''  // 권한
};
//
// global.timeCapsuleEggImg = {
//   default :"/images/icon/icon_map_marker.png",
//   open : "/images/icon/icon_map_marker_open.png"
// };
//
// //화면별 코드타입
// global.pageType = {
//   en : 'EN',              //엔딩노트
//   im : 'IM',              // 나는
//   me : 'ME',              // me
//   bucketList : 'BL',      // 버킷리스트
//   bucketStory: 'BS',      // 버키스토리
//   bucketPlan: 'BP',       // 실행계획
//   timeCapsule : 'TC',     // 타임캡슐
//   lifeMap : 'LM',         // 라이프맵
//   inHeritance : 'IH',     // 상속
//   lifeTrace : 'LT',        // 나는 > 보금자리
//   myGuardian : 'MG',
//   imGuardian : 'IG',
//   future: 'FT'            // 미래
// };
//
// global.pageTypeName = {
//   EN : '엔딩노트',
//   IM : '나는',
//   ME : 'Me',
//   BL : '버킷리스트',
//   BS : '버키스토리',
//   TC : '타임캡슐',
//   LT : '발자취',
//   MG : '나의 가디언',
//   IG : '내가 가디언',
//   IH : '상속'
// };
//
// global.lifeTraceType = {
//   home : 'home',
//   school : 'school',
//   social : 'social'
// };
//
// global.Message = {
//   comment : '댓글을 썼습니다.',
//   bucketList : {
//     write : '버킷을 등록했습니다.',
//     // delete : ' 삭제했습니다.',
//     execPlanWrite : function(count){
//       if(count > 0){
//         return '실행계획을 ' + count + '개 등록했습니다.';
//       } else {
//         return '실행계획을 등록했습니다.';
//       }
//     },
//     execPlanDelete : '실행계획을 삭제했습니다.',
//     like : '좋아합니다.',
//     favorite : '즐겨찾기 했습니다.',
//     follow : '따라하기 시작했습니다.',
//     followMe : '따라하기 시작했습니다.',
//     bucketStoryWrite : '을 등록했습니다.',
//     bucketStoryDelete : '을 추억으로 이동했습니다.',
//     bucketStoryComment : '에 댓글을 썼습니다.',
//     bucketStoryLike : '을 좋아합니다.',
//     complete : '버킷을 완료했습니다.',
//     leaveBucket : '그룹에서 나갔습니다'
//   },
//   timeCapsule: {
//     write : '타임캡슐을 등록했습니다.',
//     delete : '타임캡슐을 삭제했습니다.',
//     bury : '타임캡슐이 매립되었습니다.',
//     unseal : '타임캡슐을 개봉했습니다.',
//     like : '을 좋아합니다.',
//     writeMessage : '메세지를 등록했습니다.',
//     deleteMessage : '메세지를 삭제했습니다.',
//     editMessage : '메세지를 수정했습니다.',
//     leaveCapsule : '타임캡슐을 나갔습니다.',
//     public :  '타임캡슐을 공개(익명)로 등록했습니다.'
//   },
//   inheritance: {
//     addInheritor : '님을 상속인으로 추가했습니다.',
//     delInheritor : '님을 상속인에서 제외했습니다.',
//     setInhContent : '님께 컨텐츠를 상속 설정했습니다.',
//     editInhContent : '님의 컨텐츠 상속 내용을 변경했습니다.',
//     canselInhContent : '님의 컨텐츠 상속 설정을 취소했습니다.',
//     letterwrite : '님께 마지막편지를 상속 설정했습니다.',
//     letterwriteAll : '전체에게 마지막편지를 상속 설정했습니다.',
//     letterEdit : '님의 마지막편지 상속 내용을 변경했습니다.',
//     letterDelete : '님의 마지막편지 상속 설정을 취소했습니다.',
//     assetWrite : '님께 자산 상속 설정했습니다.',
//     assetEdit : '님의 자산 상속 내용을 변경했습니다.',
//     assetDelete : '님의 자산 상속 설정을 취소했습니다.',
//     directInhContent : '님께 컨텐츠를 지금상속 했습니다.',
//     requestDelInh : '님의 상속 내용을 삭제요청 했습니다.',
//     deletedInh : '님의 상속 내용이 삭제되었습니다.',
//     restoreDelInh : '님의 상속 삭제 요청을 취소 하였습니다.',
//     refuseInh : '님으로부터의 상속을 거부 설정했습니다.',
//     restoreInh : '님으로부터의 상속을 거부를 철회했습니다.',
//     funeralInvitation : '장례식 초대장을 작성했습니다.',
//     // '님께 상속을 받았습니다.',
//     requestedGuadian : '님이 가디언을 요청했습니다.',
//     acceptGuadian : '님의 가디언이 되었습니다.',
//     requestGuad : '님께 가디언을 요청했습니다.',
//     acceptedGuadian : '님이 가디언이 되었습니다.',
//     delGuardian : '님을 가디언에서 삭제했습니다.',
//     // '님의 부고 알림이 접수되었습니다.',
//     refuseGuadian : '님의 가디언 요청을 거절 하였습니다.',
//
//   }
// };
//
// global.notification = {
//   comment: ' 댓글을 달았습니다.',
//   subComment : ' 댓글에 답글을 달았습니다.',
//   like: ' 좋아요 했습니다.',
//   follow: ' 따라하기 했습니다.',
//   bucketStory: {
//     write: ' 생성했습니다.'
//   },
//   bucketList : {
//     write: ' 생성했습니다.',
//     delete: ' 그룹에서 빠졌습니다.',
//     manyWrite : '회원님이 최고의 꿈쟁이 순위에 진입했습니다.',
//     manyComplete : '회원님이 최고의 꿈실현가 순위에 진입했습니다',
//     // delete : ' 삭제했습니다.',
//     manyWriteVIP : function(num){
//       if(num > 0){
//         return '회원님은 현재 상위 ' + num + '%의 꿈쟁이 입니다.';
//       }
//     },
//     manyCompleteVIP : function(num){
//       if(num > 0){
//         return '회원님은 현재 상위 ' + num + '%의 꿈실현가 입니다.';
//       }
//     },
//   },
//   timeCapsule: {
//     write : ' 생성했습니다.',
//     receive: '회원님이 받으신 타임캡슐이 있습니다.',
//     message: ' 메시지 작성했습니다.',
//     bury: ' 묻었습니다.',
//     open: ' 개봉했습니다.',
//     openPlz : ' 열어주세요.',
//     delete : ' 삭제했습니다.',
//   },
//   inheritance: {
//     inherit : '님으로부터 상속받은 내역이 있습니다.'
//   },
//   guardian: {
//     receive : '님이 가디언 등록을 요청했습니다.',
//     accept : '님이 가디언 요청을 수락했습니다.',
//     refusal : '님이 가디언 요청을 거절했습니다.',
//   },
//   message: {
//     msgReceive : '님에게 쪽지를 받았습니다.',
//     recommend : '1:1문의에 답변이 등록되었습니다.',
//     signUp : "It's my story 회원이 되신 것을 환영합니다.",
//     payment : "서비스 이용료 결제가 완료되었습니다.",
//     paymentError: function(cnt){
//       if(cnt){
//         return '[중요] 3차 결제 오류로 멤버십이 변경됩니다.';
//       } else {
//         return '[중요] 결제 오류가 발생했습니다. 확인 바랍니다.';
//       }
//     },
//     changePassword : '[중요] 비밀번호를 변경해주세요'
//   },
//   friends: {
//     receive : '님이 친구 등록을 요청했습니다.',
//     accept : '님이 친구 요청을 수락했습니다.',
//     refusal : '님이 친구 요청을 거절했습니다.'
//   },
//   /*jshint multistr: true */ //멀티라인 사용하기 위함
//   messageContext: {
//     deletedTC : "안녕하세요, 회원님.<br/><br/> \
//     index[0]에 생성된 'index[1]' 타임캡슐이<br/> \
//     아래와 같은 사유로 삭제되었습니다.<br/><br/> \
//     index[2]님이 타임캡슐을 삭제<br/><br/>  \
//     삭제된 타임캡슐은 엔딩노트 타임라인이나  타임캡슐<br/> \
//     목록에서 보이지 않습니다.<br/><br/> \
//     서비스 이용에 문의사항이 있으시면 고객센터로<br/> \
//     연락주시기 바랍니다.<br/><br/> \
//     감사합니다.",
//     signUp : '안녕하세요, 회원님.<br/><br/> \
//     It’s my Story 회원이 되신 것을 진심으로<br/> \
//     축하드립니다.<br/><br/> \
//     It’s my Story를 통해 삶을 기록하고 계획하며,<br/> \
//     긍정적으로 변화하는 자신의 모습을 발견하시면<br/> \
//     좋겠습니다.<br/><br/> \
//     서비스 이용에 궁금하신 사항이 있으시면 아래<br/>\
//     메뉴를 이용해주세요.<br/><br/> \
//     <div class="indent" style="text-indent: 11px; color: blue;"> \
//     ● 고객센터 : <a herf="javascript.void(0)" name="notice">공지사항</a>, <a herf="javascript.void(0)" name="faq">FAQ</a>, <a herf="javascript.void(0)" name="qna">1:1문의</a>, <a herf="javascript.void(0)" name="help">도움말</a> \
//     </div><br/> \
//     감사합니다.<br/> \
//     YOLO!!',
//     paymentError1st : '안녕하세요, 회원님. \
//     index[0]에 서비스 이용료 결제 예정이었으나, 아래와 같은 사유로 결제에 실패했습니다. \
//     오류내용 : 폐기된 카드번호(index[1]) \
//     index[2]에 2차 결제 예정이오니, 위 사항을 참고하시기 바랍니다. \
//     결제 오류 발생 시 공지 후 3차까지 재결제가 시도되며, 3차 결제 시도에도 오류가 발생하는 경우 멤버십이 일시 정지되오니, 이 점 유의하세요 \
//     만약, 결제 정보에 변동사항 및 이상이 없는데 오류가 계속되는 경우, 고객센터(1:!문의)로 연락주시기 바랍니다. \
//     감사합니다.',
//     paymentError2st : '안녕하세요, 회원님. \
//     안내드린 바와 같이 index[0]에 2차 결제를 시도하였으나, 아래 사유로 결제에 실패했습니다. \
//     오류내용 : 폐기된 카드번호(index[0]) \
//     index[0]에 3차 결제 예정이오니, 위 사항을 참고하시기 바랍니다. \
//     결제 오류 발생 시 공지 후 3차까지 재결제가 시도되며, 3차 결제 시도에도 오류가 발생하는 경우 멤버십이 일시 정지되오니, 이 점 유의하세요. \
//     만약, 결제 정보에 변동사항 및 이상이 없는데 오류가 계속되는 경우, 고객센터(1:!문의)로 연락주시기 바랍니다. \
//     감사합니다.',
//     paymentError3st : '안녕하세요, 회원님. \
//     안내드린 바와 같이 index[0]에 3차 결제를 시도하였으나, 아래 사유로 결제에 실패했습니다. \
//     오류내용 : 폐기된 카드번호(index[1]) \
//     3차 재결제도 실패했기 때문에, 공지드린 바와 같이 index[2]부터 index[3]멤버십이 일시 정지됩니다. \
//     작성하신 컨텐츠는 보존되나 기존의 유료 멤버십의 혜택은 제공되지 않으며, 무료 멤버십으로 전환됩니다. \
//     멤버십 원복을 원하시는 경우, 유료 멤버십 서비스를 결제하시면 됩니다. 멤버십 변경 바로가기 \
//     문의 사항이 있으신 경우 고객센터(1:!문의)로 연락주세요. \
//     감사합니다.',
//     payment : '안녕하세요, 회원님. \
//     index[0], ㅇㅇ멤버십에 대한 서비스 이용료 결제가 완료되었습니다. \
//     멤버십 적용 기간은 아래와 같습니다. \
//     index[1]멤버십 (index[2] ~ index[3]) \
//     서비스 이용에 문의사항이 있으시면 고객센터로 연락주시기 바랍니다. \
//     감사합니다.'
//   }
// };
//
// global.TimeLinelifeTraceFixedText = {
//   lifeTraceFromHome : '시작',
//   lifeTraceToHome : '종료',
//   lifeTraceFromSchool : '입학',
//   lifeTraceToSchool : '졸업',
//   lifeTraceFromSocial : '시작',
//   lifeTraceToSocial : '종료'
// };
//
// // 카테고리 코드
// global.category = {
//   // 버킷카테고리
//   CA001: '[먹고싶은] keyword',
//   CA002: '[가고싶은] keyword',
//   CA003: '[하고싶은] keyword',
//   CA004: '[갖고싶은] keyword',
//   CA005: '[되고싶은] keyword',
//   CA006: '[보고싶은] keyword',
//
//   // 오늘의 질문 title1
//   NM0001: '좋아하는 keyword',
//   NM0002: '가고 싶은 keyword',
//   NM0003: '나를 돌아보기 좋은 장소 keyword',
//   NM0004: '편안한 장소 keyword',
//   NM0005: '좋아하는 색은 keyword',
//   NM0006: '연중 가장 기다려지는 keyword',
//   NM0007: '즐겨듣는 keyword',
//   NM0008: '하루 중 가장 기다려지는 keyword',
//   NM0009: '좋아하는 별자리는 keyword',
//   NM0010: '지금 가장 생각나는 분은 keyword',
//   NM0011: '좋아하는 영화 종류는 keyword',
//   NM0012: '좋아하는 스포츠는 keyword',
//   NM0013: '지금 가장 중요한 분은 keyword',
//   NM0014: '좋아하는 음식은 keyword',
//   // NM0015: 'keyword은/는 나를 편하게 한다',
//   NM0015: 'keyword|postPositionD 나를 편하게 한다',
//   NM0016: 'keyword에 행복함을 느낀다',
//   NM0017: 'keyword|postPositionB 있으면 힘이 솟는다',
//   NM0018: '나는 keyword|postPositionB 싫다',
//   NM0019: '나는 keyword|postPositionB 무섭다',
//   NM0020: '내 별명은 keyword',
//   NM0021: '지금 가장 친한 분은 keyword',
//   NM0022: 'keyword|postPositionB 지금 가장 열심히 활동하는 모임이다',
//   NM0023: '좋아하는 TV 프로그램은 keyword',
//   NM0024: '내가 좋아하는 옷 keyword',
//   NM0025: '나는 keyword 때문에 고생이다',
//   NM0026: '지금 keyword|postPositionB 가장 걱정이다',
//   NM0027: '노래 keyword|postPositionD 추억을 떠오르게 한다'
// };
//
// // 타임라인 왼쪽바디 타이틀
// global.timelineLeftTitle = {
//   IM: '다른 분들의 관련 추억..',
//   BL: '다른 분들의 관련 버킷리스트..',
//
//   // 오늘의 질문 title2
//   // |postPositionA : 을/를
//   // |postPositionB : 이/가
//   // |postPositionC : 으로/로
//   // |postPositionD : 은/는
//   // NM0001: 'keyword|postPositionA 좋아하는분 count명',
//   // NM0002: 'keyword|postPositionA 가고 싶어하는분 count명',
//   // NM0003: 'keyword에서 스스로 생각하는 분 count명',
//   // NM0004: 'keyword|postPositionA 편안한 장소로 생각하는 분 count명',
//   // NM0005: 'keyword|postPositionA 좋아하는 분 count명',
//   // NM0006: '연중 keyword|postPositionA 가장 기다리는 분 count명',
//   // NM0007: 'keyword|postPositionA 즐겨듣는 count분의 글은...',
//   // NM0008: '하루 중 keyword|postPositionA 가장 기다리는 분 count명',
//   // NM0009: 'keyword|postPositionA 좋아하는 분 count명',
//   // NM0010: '',
//   // NM0011: 'keyword|postPositionA 좋아하는 분 count명',
//   // NM0012: 'keyword|postPositionA 좋아하는 분 count명의 추억은',
//   // NM0013: '',
//   // NM0014: 'keyword|postPositionA 좋아하는 분 count명',
//   // NM0015: 'keyword|postPositionB 있으면 편하게 느끼는 분 count명',
//   // NM0016: 'keyword에 행복함을 느끼는 분 count명',
//   // NM0017: '동기부여애 keyword|postPositionB 도움이 되는 분 count명',
//   // NM0018: 'keyword|postPositionA 싫어하는 분 count명',
//   // NM0019: 'keyword|postPositionA 무서워하는 분 count명',
//   // NM0020: 'keyword이 별명인 분 count명',
//   // NM0021: '',
//   // NM0022: '',
//   // NM0023: 'TV 프로그램 keyword|postPositionA 좋아하는 분 count명',
//   // NM0024: 'keyword|postPositionA 좋아하는 분 count명',
//   // NM0025: 'keyword|postPositionD 불편한 분 count명',
//   // NM0026: 'keyword|postPositionA 걱정하는 분 count명',
//   // NM0027: '노래 keyword에 추억을 느끼는 분 count명'
//   NM0001: 'keyword|postPositionA 좋아하는 분들의 추억은..',
//   NM0002: 'keyword|postPositionA 가고 싶어하는 분들의 추억은..',
//   NM0003: 'keyword에서 스스로 생각하는 분들의 추억은..',
//   NM0004: 'keyword|postPositionA 편안한 장소로 생각하는 분들의 추억은..',
//   NM0005: 'keyword|postPositionA 좋아하는 분들의 추억은..',
//   NM0006: '연중 keyword|postPositionA 가장 기다리는 분들의 추억은..',
//   NM0007: 'keyword|postPositionA 즐겨듣는 분들의 추억은..',
//   NM0008: '하루 중 keyword|postPositionA 가장 기다리는 분들의 추억은..',
//   NM0009: 'keyword|postPositionA 좋아하는 분들의 추억은..',
//   NM0010: '',
//   NM0011: 'keyword|postPositionA 좋아하는 분들의 추억은..',
//   NM0012: 'keyword|postPositionA 좋아하는 분들의 추억은..',
//   NM0013: '',
//   NM0014: 'keyword|postPositionA 좋아하는 분들의 추억은..',
//   NM0015: 'keyword|postPositionB 있으면 편하게 느끼는 분들의 추억은..',
//   NM0016: 'keyword에 행복함을 느끼는 분들의 추억은..',
//   NM0017: '동기부여애 keyword|postPositionB 도움이 되는 분들의 추억은..',
//   NM0018: 'keyword|postPositionA 싫어하는 분들의 추억은..',
//   NM0019: 'keyword|postPositionA 무서워하는 분들의 추억은..',
//   NM0020: 'keyword이 별명인 분들의 추억은..',
//   NM0021: '',
//   NM0022: '',
//   NM0023: 'TV 프로그램 keyword|postPositionA 좋아하는 분들의 추억은..',
//   NM0024: 'keyword|postPositionA 좋아하는 분들의 추억은..',
//   NM0025: 'keyword|postPositionD 불편한 분들의 추억은..',
//   NM0026: 'keyword|postPositionA 걱정하는 분들의 추억은..',
//   NM0027: '노래 keyword에 추억을 느끼는 분들의 추억은..'
// };
//
//
//

//
//
//
// global.s3 = {
//   bucketPath : 'https://s3-ap-northeast-2.amazonaws.com/iml-images/',
//   folder : {
//     im : 'im_story_images',
//     bucketList:'bucketlist_images',
//     bucketStory:'bucket_story_images',
//     timeCapsule:'time_capsule_images',
//     withMe:'im_with_me',
//     inheritance:'inheritance_images',
//     profile:'profile_images',
//     future:'future_images',
//     customer:'customer_desk'
//   }
// };
//
// // froalaEditor 설정
// global.editorSettings = {
//   heightMin : 150,
//   key : 'Rxfb1ylecwkcI2C-21rs=='
// };
// global.editorSettings.toolbarButtons = [
//   // 'fullscreen',
//   'bold',
//   'italic',
//   'underline',
//   // 'strikeThrough',
//   // 'subscript',
//   // 'superscript',
//   // 'fontFamily',
//   'fontSize',
//   '|',
//   // 'paragraphFormat',
//   // 'align',
//   // 'formatOL',
//   // 'formatUL',
//   // 'outdent',
//   // 'indent',
//   // 'quote',
//   // 'insertHR',
//   // '-',
//   // 'insertLink',
//   'insertImage',
//   // 'insertVideo', 'insertFile', 'insertTable', 'undo', 'redo', 'clearFormatting', 'selectAll',
//   'html'
// ];
// global.editorSettings.imageEditButtons = [
//   //'imageReplace',
//   'imageAlign',
//   'imageRemove',
//   //'|', 'imageLink',
//   //'linkOpen',
//   //'linkEdit',
//   //'linkRemove',
//   //'-',
//   'imageDisplay',
//   //'imageStyle',
//   //'imageAlt',
//   'imageSize'
// ];
//
// global.pageInterval = {
//   timeCapsuleMessage : {
//     limit: 3,
//     skip: 0
//   },
//   inheritanceContentsList : {
//     limit: 4,
//     skip: 0
//   }
// };
//
// global.profileDefaultImg = '/images/bg/avata_big.png';//'/images/bg/avata_big.png'
//
// global.imageRatio = {
//   timelineLeft61 : {
//     ratio : 61,
//     width : 49,
//     height : 30
//   },
//   timelineLeft55 : {
//     ratio : 55,
//     width : 54,
//     height : 30
//   },
//   timelineRight64 : {
//     ratio : 64,
//     width : 73,
//     height : 47
//   },
//   contentsList59 : {
//     ratio : 59,
//     width : 84,
//     height : 50
//   },
//   imgSlider56 : {
//     ratio : 56,
//     width : 79,
//     height : 45
//   }
// };
//
// global.mapDefault = {
//   zoom : 8,
//   lat : 37.537798,
//   lng : 127.001216
// };
//###################################################################################################################################
//###################################################### UTILITY ####################################################################
//###################################################################################################################################

//자주 사용하는 함수를 정의
//'util'을 preFix로 사용함

// ex)
// utilExample = function(after, before) {
//  var result = _.isEqual(after, before);
//  return result;
// };


// 2017. 1. 4. 오후 4:27:02
// 2017-01-03 15:05:10


global.utilGetDate = function(date) {
  if (_.isUndefined(date) || _.isNull(date) || _.isEmpty(date)) {
    if(Meteor.isClient){
      if(!TimeSync.isSynced()){
        TimeSync.resync();
      } else {
        date = Deps.nonreactive(function(){
          return new Date(TimeSync.serverTime()).toISOString();
        });
      }
    } else {
      date = new Date().toISOString();
    }
  }
  return {
    default: date,
    defaultHMS: new Date(date).format('yyyy-MM-dd HH:mm:ss'),
    defaultYMD: new Date(date).format('yyyy-MM-dd'),
    defaultYM : new Date(date).format('yyyy-MM'),
    defaultYMDdot: new Date(date).format('yyyy.MM.dd'),
    defaultYMdot: new Date(date).format('yyyy.MM'),
    kor: new Date(date).format('yyyy년 MM월 dd일 HH:mm:ss'),
    korYMD: new Date(date).format('yyyy년 MM월 dd일'),
    hm: new Date(date).format('HH:mm'), // 시/분
    md: new Date(date).format('MM-dd')
  };
};

String.prototype.string = function(len){var s = '', i = 0; while (i++ < len) { s += this; } return s;};
String.prototype.zf = function(len){return "0".string(len - this.length) + this;};
Number.prototype.zf = function(len){return this.toString().zf(len);};
Date.prototype.format = function(f) {
  if (!this.valueOf()) return undefined;

  var weekName = ["일요일", "월요일", "화요일", "수요일", "목요일", "금요일", "토요일"];
  var d = this;

  return f.replace(/(yyyy|yy|MM|dd|E|hh|mm|ss|a\/p)/gi, function($1) {
    switch ($1) {
      case "yyyy": return d.getFullYear();
      case "yy": return (d.getFullYear() % 1000).zf(2);
      case "MM": return (d.getMonth() + 1).zf(2);
      case "dd": return d.getDate().zf(2);
      case "E": return weekName[d.getDay()];
      case "HH": return d.getHours().zf(2);
      case "hh": return ((h = d.getHours() % 12) ? h : 12).zf(2);
      case "mm": return d.getMinutes().zf(2);
      case "ss": return d.getSeconds().zf(2);
      case "a/p": return d.getHours() < 12 ? "오전" : "오후";
      default: return $1;
    }
  });
};

// froala editor upload files to S3(AWS)
global.utilFroalaUpload = function(folderPath) {
  var crypto = require('crypto');

  var expiration = moment.utc(moment().add(2, 'days')).toISOString();
  var metaDate = moment().format('YYYYMMDD');
  var metaCredential = S3.config.key+ '/' + moment().format('YYYYMMDD') +'/' + S3.config.region + '/s3/aws4_request';
  var metaStartsWithPath = folderPath + '/';
  var metaAcl = 'public-read';
  //var acl = 'private';

  var policy = {
    'expiration': expiration,
    'conditions': [
      {'bucket': S3.config.bucket},
      {'acl': metaAcl},
      {'success_action_status': '201'},
      {'x-requested-with': 'xhr'},
      {'x-amz-algorithm': 'AWS4-HMAC-SHA256'},
      {'x-amz-credential': metaCredential},
      {'x-amz-date': metaDate + 'T000000Z'},
      ['starts-with', '$key', metaStartsWithPath],
      ['starts-with', '$Content-Type', '']// # Accept all files.
    ]
  };

  var policy64 = new Buffer(JSON.stringify(policy), 'utf-8').toString('base64');

  // generate signing key
  var kDate = crypto.createHmac('sha256', "AWS4" + S3.config.secret).update(metaDate).digest('');
  var kRegion = crypto.createHmac('sha256', kDate).update(S3.config.region).digest('');
  var kService = crypto.createHmac('sha256', kRegion).update('s3').digest('');
  var kSigning = crypto.createHmac('sha256', kService).update("aws4_request").digest('');

  // generate signature.V4
  var signature = crypto.createHmac("sha256", kSigning).update(policy64).digest("hex");

  // build the results object
  var s3Credentials = {
    s3Policy: policy64,
    s3Signature: signature,
    s3Credentials : metaCredential,
    s3Date : metaDate + 'T000000Z'
  };

  // return S3 signature and policy for client or server to use
  return s3Credentials;
};

//모달팝업 호출 시 사용
global.utilModalOpen = function(e, obj) {
  Template.modal.__helpers.get('modalRequest')(e, obj); // modal 템플릿의 헬퍼를 호출 (template) 템플릿이름을 파라미터값으로 넘김
};
// alert호출
global.utilAlert = function(message, target) {
  swal({
    title: target ? global.fn_toUpperCase(target) : 'ALERT',
    type: target ? target : 'warning',
    text : message,
    allowOutsideClick: false,
    customClass:'popup-alert',
    confirmButtonText: '확인',
    showCloseButton:true
  });
};

// confirm 호출
// 사용법 global.utilConfirm(message).then(function(val) { if (val) -->> 로직시작 } )
global.utilConfirm = function(message, target, button) {
  if (!button) {
    button = {
      confirm: '확인',
      cancel: '취소'
    };
  }
  return new Promise(function(resolve, reject) {
    if (!target) {
      target = 'question';
    }
    swal({
      title: 'Confirm',
      type: target,
      html : message,
      allowOutsideClick: false,
      showCancelButton: true,
      confirmButtonText: button.confirm,
      cancelButtonText: button.cancel,
      customClass:'popup-confirm',
      showCloseButton:true
    }).then(function(result) {
      resolve(result);
    }, function(dis) {
      if(dis){
        reject(dis);
      }
    });
  });
};

// 두 날짜사이에 속해있는지 확인 polyLine용도 (returnType : boolen)
global.utilIsContainDateforPoly = function(from, to, homeFrom, homeTo, periodFrom, priodTo) {
  var sFrom = Date.parse(from); //회사, 학교 From
  var sTo = Date.parse(to); //회사, 학교 To
  var hFrom = Date.parse(homeFrom); // 집 From
  var hTo = Date.parse(homeTo); // 집 To
  var pFrom = Date.parse(periodFrom); //검색기간 From
  var pTo = Date.parse(priodTo); //검색기간 To

  if(sFrom > hTo || sTo < hFrom) {
    return false;
  }

  if((pFrom <= hTo && pFrom <= sTo) && (pTo >= hFrom && pTo >= sFrom)) {
    return true;
  }

  return false;
};

// 두 날짜사이에 속해있는지 확인 (returnType : boolen)
global.utilIsContainDate = function(from, to, periodFrom, priodTo) {
  var sFrom = Date.parse(from); // From
  var sTo = Date.parse(to); // To
  var pFrom = Date.parse(periodFrom); //검색기간 From
  var pTo = Date.parse(priodTo); //검색기간 To

  if(pFrom > sTo || pTo < sFrom) {
    return false;
  }
  return true;
};

// 특정시점의 나이 구하기
global.utilGetPastAge = function(birthday, pastDate) {
  var years = 0;
  //pastdate 이 빈 object 일때 (에러방어코딩)
  if(typeof(pastDate)!=="string" && !pastDate.hasOwnProperty()){
    pastDate = birthday;
  }

  if (birthday) {
    var birthdayDate = new Date(birthday);
    var enddayDate = new Date(pastDate.replace(".","-"));

    years = enddayDate.getFullYear() - birthdayDate.getFullYear();

    // // 현재 년도에서 생일을 재설정
    // birthdayDate.setFullYear(enddayDate.getFullYear());
    // // 생일이 지났으면 -1
    // if(enddayDate < birthdayDate) {
    //   years --;
    // }
  }

  return years + 1;
};

// 문자열 특정숫자만큼 자르기
global.utilEllipsis = function(str, maxLen) {
  if (str.length > maxLen) {
    str = str.substring(0, maxLen) + '...';
  }
  return str;
};

// Validation 체크
global.utilValidation = function(t) {
  var returnFlag = true;
  var input = t.findAll('input');
  var select = t.findAll('select');
  var textarea = t.findAll('textarea');

  var targetList = [].concat(input, select, textarea);

  Array.prototype.map.call(targetList, function(targets) {
    if (Boolean(targets.required) && returnFlag) {
      if(targets.type === 'checkbox') {
        if (!targets.checked) {
          returnFlag = false;
          targets.focus();
          return global.utilAlert(targets.title);
        }
      } else {
        if (!targets.value) {
          returnFlag = false;
          targets.focus();
          return global.utilAlert(targets.title);
        }
      }
    }
  });

  return returnFlag;
};

// 글등록 -> (timeline & history) Collection insert
global.utilTimelineRegister = function(postId, userId, type, startDay, endDay, historyType) {
  var timelineArr = [];
  var firstPosition = 1;
  var isInsertHistory = true;
  var count = 2;
  if (type === global.pageType.bucketList || type === global.pageType.timeCapsule) {
    count = 3;
  }

  //히스토리를 등록하지 않는 타입을 여기에 정의한다.
  // if(_.isEqual(type, 'LT') || _.isEqual(type, 'ME') || _.isEqual(type, 'BS') || _.isEqual(type, 'BP') || _.isEqual(type, 'WM') || _.isEqual(type, 'FT')){
  //   firstPosition = 1;
  //   isInsertHistory = false;
  // }

  var thisTime = global.utilGetDate().default;
  for (var i = firstPosition; i < count; i++) {
    var timelineObj = {
      postId: postId,
      userId: userId,
      timeClass: 'start',
      updateDate: thisTime,
      regDate: thisTime
    };
    switch(i) {
      case 0:
      timelineObj.contentType = 'H';
      timelineObj.type = type;
      timelineObj.timeClass = 'start';
      timelineObj.timelineDate = global.utilGetDate().defaultYMD;
      timelineObj.sort = 2;
      break;
      case 1:
      timelineObj.contentType = 'E';
      timelineObj.type = type;
      timelineObj.timeClass = 'start';
      timelineObj.timelineDate = startDay ? global.utilGetDate(startDay).defaultYMD : '';
      timelineObj.sort = 1;
      break;
      case 2:
      timelineObj.contentType = 'E';
      timelineObj.type = type;
      timelineObj.timeClass = 'end';
      timelineObj.timelineDate = endDay ? global.utilGetDate(endDay).defaultYMD : '';
      timelineObj.sort = 1;
      break;
    }
    timelineArr.push(timelineObj);
  }
  Meteor.call('enTimelineInsert', timelineArr);
  // if (!historyType) {
  //   historyType = 'WR';
  // }
  //히스토리 컬렉션 등록
  // var historyObj = {
  //   postId: postId,
  //   typeKey: postId,
  //   commentKey: '',
  //   userId: userId,
  //   postType: type,
  //   type: historyType,
  //   user: '',
  //   timelineDate: global.utilGetDate().defaultYMD,
  //   updateDate: global.utilGetDate().default
  // };
  //
  // if(isInsertHistory) {
  //   setTimeout(function() {
  //     Meteor.call('enHistoryUpsert', null, historyObj);
  //   }, 100);
  // }
};

// 히스토리 글등록 추가하기
global.utilHistoryWrite = function(obj, crud) {
  var historyMethod = null;
  var historyObj = {};
  if (crud === 'insert') {
    historyMethod = 'enHistoryInsert';
    historyObj = {
      postId: obj.postId,
      typeKey: obj.subPostId,
      commentKey: '',
      userId: obj.postUser,
      postType: obj.postType,
      type: 'WR',
      user: obj.user,
      timelineDate: global.utilGetDate().defaultYMD,
      regDate: global.utilGetDate().default,
      updateDate: global.utilGetDate().default
    };
  } else if (crud === 'remove') {
    historyMethod = 'enHistoryDelete';
    historyObj = {
      typeKey: obj.subPostId
    };
  }

  var timelineObj = [{
    userId: global.login.userId,
    contentType: 'H',
    timeClass: 'start',
    timelineDate: global.utilGetDate().defaultYMD
  }];

  if (crud !== 'remove') {
    Meteor.call('enTimelineUpdate', obj.postId, timelineObj);
  }
  setTimeout(function() {
    Meteor.call(historyMethod, obj.postId, historyObj);
  }, 100);
};

// 히스토리 좋아요 추가하기
global.utilHistoryLike = function(postId, postUser, likeUser, likeFlag, parentPostId, postType, title) {
  if (!parentPostId) {
    parentPostId = postId;
  }
  var historyObj = {
    postId: postId,
    typeKey: parentPostId,
    commentKey: '',
    userId: postUser,
    postType: postType,
    type: 'LK',
    user: likeUser,
    timelineDate: global.utilGetDate().defaultYMD,
    regDate: global.utilGetDate().default,
    updateDate: global.utilGetDate().default
  };
  var historyMethod = null;
  if (likeFlag) {
    // 이미 좋아요하는경우에는 히스토리에서 좋아요 삭제
    historyMethod = 'enHistoryDelete';
    delete historyObj.timelineDate;
    delete historyObj.regDate;
    delete historyObj.updateDate;
  } else {
    historyMethod = 'enHistoryInsert';

    // 좋아요 알림
    if (postUser !== global.login.userId) {
      var options = {
        userId : likeUser,
        title: title
      };
      if (postType === 'BS') {
        postId = parentPostId;
      }
      Meteor.call('setNoti', postUser, postType, postId, 'like', options);
    }
  }

  // Meteor.call(historyMethod, postId, historyObj, function(error) {
  //   if (error) {
  //     return alert(error);
  //   } else {
  //     var timelineObj = [{
  //       userId: postUser,
  //       contentType: 'H',
  //       timeClass: 'start',
  //       timelineDate: global.utilGetDate().defaultYMD
  //     }];
  //     Meteor.call('enTimelineUpdate', postId, timelineObj);
  //   }
  // });
};

// 히스토리 댓글 추가하기 = 로그 및 알림 추가하기
global.utilHistoryComment = function(obj, crud) {
  var historyObj = {};
  var meteorMethod = null;
  if (crud === 'insert' || crud === 'insert_sub') {
    meteorMethod = 'enHistoryInsert';
    historyObj = {
      postId: obj.postId,
      typeKey: obj.typeKey,
      commentKey: obj.commentKey,
      userId: obj.postUserId, // 댓글이 달린 글의 주인
      postType: obj.type,
      type: 'CM',
      user: obj.userId, // 댓글을 단사람
      timelineDate: global.utilGetDate().defaultYMD,
      regDate: global.utilGetDate().default,
      updateDate: global.utilGetDate().default
    };
    // 알림 추가(글유저와 댓글유저가 다를때만 알림)
    if (obj.postUserId !== obj.userId || crud === 'insert_sub') {
      var notifiUser = obj.postUserId;
      if (crud === 'insert_sub') {
        notifiUser = obj.replyUserId;
      }
      var options = {
        userId : obj.userId,
        title: obj.title
      };
      var comment = crud === 'insert' ? 'comment': 'subComment';
      if (obj.type === 'BS') {
        obj.postId = obj.typeKey;
      }
      Meteor.call('setNoti', notifiUser, obj.type, obj.postId, comment, options);
    }
  }
  // else {
  //   meteorMethod = 'enHistoryDelete';
  //   historyObj = {
  //     postId: obj.postId,
  //     commentKey: obj.cmtKey
  //   };
  // }
  // var timelineObj = [{
  //   userId: obj.postUserId,
  //   contentType: 'H',
  //   timeClass: 'start',
  //   timelineDate: global.utilGetDate().defaultYMD
  // }];
  //
  // Meteor.call(meteorMethod, obj.postId, historyObj, function(error) {
  //   if (error) {
  //     return alert(error);
  //   } else {
  //     if (crud !== 'remove') {
  //       Meteor.call('enTimelineUpdate', obj.postId, timelineObj);
  //     }
  //   }
  // });
};

// 히스토리 데이터 추가하기
global.utilHistoryInsert = function(obj) {
  var timelineObj = {
    userId: obj.userId,
    contentType: 'H',
    timeClass: 'start',
    timelineDate: global.utilGetDate().defaultYMD
  };

  Meteor.call('enTimelineUpdateOne', obj.postId, timelineObj);
  Meteor.call('enHistoryInsert', obj.postId, obj);
};

// 히스토리 데이터 삭제하기
global.utilHistoryDelete = function(obj) {
  Meteor.call('enHistoryDelete', obj.postId, obj);
};

// 유저 닉네임 가져오기
global.utilGetNickName = function(userId) {
  var userInfo = Meteor.users.find({username: userId}).fetch()[0];
  if (userInfo) {
    return userInfo.profile.nickName;
  }
};

global.utilGetUsersInfo = function(userIds, searchOption){
  var selectedField = {};
  if(searchOption){
    for(var i=0 ; i<searchOption.length ; i++){
      selectedField[searchOption[i]] = 1;
    }
  } else {
    // console.error('option은 필수 요소 입니다.');
    return;
  }
  return Meteor.users.find({username: {$in:userIds}},{fields:selectedField}).fetch();
};

// 글자수 자르기
global.utilStrCut = function(str, len) {
  if (str && len < str.length) {
    str = str.substring(0, len) + '...';
  }
  return str;
};

// 태그 제거
global.utilTagRemove = function(content) {
  if (content) {
    var str = content.replace(/(<([^>]+)>)/gi, "");
    return str;
  }
};

// 템플릿이동
global.utilTemplateMove = function(header, content, data) {
  var template = {
    headerTmp: header
  };
  Session.set('endingNoteList templateData', template);

  setTimeout(function(){
    var templateData = {
      headerTmp: header,
      contentTmp: content,
      data: data
    };
    setTimeout(function() {
      Session.set('endingNoteList templateData', templateData);
    });
  }, 100);
};

// 버킷스토리 -> 추억이동
global.utilMoveStory = function(postId, parentPostId, timelineObj, historyObj, title) {
  Meteor.call('enHistoryMoveStoryTimeline', postId, parentPostId, timelineObj, function(error) {
    if (error) {
      return alert(error);
    } else {
      Meteor.call('enHistoryMoveStoryHistory', postId, parentPostId ,historyObj);
      Meteor.call('deleteLog', null, null, postId, null, null, function(error, result){
        if(error) {
          return console.log(error);
        } else {
          Meteor.call('setLog', parentPostId, postId, global.login.userId, global.login.userId, global.pageType.bucketList, global.utilGetNickName(global.login.userId) + global.Message.bucketStoryComment, 'bucketStoryDelete', title); //버킷리스트의 히스토리란에 해당 버키스토리 기록을 모두 삭제
        }
      }); //버킷리스트의 히스토리란에 해당 버키스토리 기록을 모두 삭제
    }
  });
};

// template의 데이터 find Array형태로 가져오기
global.utilGetFormDataArray = function(template, flag) {
  var arrayData = [];
  var result = {};
  var text = template.findAll('input[type="text"]');
  var hidden = template.findAll('input[type="hidden"]');
  var checkbox = template.findAll('input[type="checkbox"]');
  var radio = template.findAll('input[type="radio"]');
  var select = template.findAll('select');
  var textarea = template.findAll('textarea');

  Array.prototype.map.call(text, function(targets) {
    if (typeof(result[targets.name]) !== typeof([])) {
      result[targets.name] = [];
    }
    result[targets.name].push(targets.value);
  });
  Array.prototype.map.call(hidden, function(targets) {
    if (typeof(result[targets.name]) !== typeof([])) {
      result[targets.name] = [];
    }
    result[targets.name].push(targets.value);
  });
  Array.prototype.map.call(checkbox, function(targets) {
    if (typeof(result[targets.name]) !== typeof([])) {
      result[targets.name] = [];
    }
    result[targets.name].push(targets.value);
  });
  Array.prototype.map.call(radio, function(targets) {
    if (typeof(result[targets.name]) !== typeof([])) {
      result[targets.name] = [];
    }
    result[targets.name].push(targets.value);
  });
  Array.prototype.map.call(select, function(targets) {
    if (typeof(result[targets.name]) !== typeof([])) {
      result[targets.name] = [];
    }
    result[targets.name].push(targets.value);
  });
  Array.prototype.map.call(textarea, function(targets) {
    if (typeof(result[targets.name]) !== typeof([])) {
      result[targets.name] = [];
    }
    result[targets.name].push(targets.value);
  });


  var keys = Object.keys(result);
  if (flag === undefined) {
    flag = true;
  }

  if (keys.length > 0 && flag) {
    var cnt = result[keys[0]].length;
    // var keys = Object.keys(result);
    for (var i = 0; i < cnt; i++) {
      var array = {};
      for (var j = 0; j < keys.length; j++) {
        if (result[keys[j]][i]) {
          array[keys[j]] = result[keys[j]][i];
        } else {
          array[keys[j]] = null;
        }
      }
      arrayData.push(array);
    }
    return arrayData;
  } else {
    return result;
  }
};

// template의 데이터 find Array형태로 가져오기
global.utilGetChlidrenDataArray = function(target, flag) {
  var arrayData = [];
  var result = {};
  var text = target.find('input[type="text"]');
  var hidden = target.find('input[type="hidden"]');
  var checkbox = target.find('input[type="checkbox"]');
  var radio = target.find('input[type="radio"]');
  var select = target.find('select');
  var textarea = target.find('textarea');

  Array.prototype.map.call(text, function(targets) {
    if (typeof(result[targets.name]) !== typeof([])) {
      result[targets.name] = [];
    }
    result[targets.name].push(targets.value);
  });
  Array.prototype.map.call(hidden, function(targets) {
    if (typeof(result[targets.name]) !== typeof([])) {
      result[targets.name] = [];
    }
    result[targets.name].push(targets.value);
  });
  Array.prototype.map.call(checkbox, function(targets) {
    if (typeof(result[targets.name]) !== typeof([])) {
      result[targets.name] = [];
    }
    result[targets.name].push(targets.value);
  });
  Array.prototype.map.call(radio, function(targets) {
    if (typeof(result[targets.name]) !== typeof([])) {
      result[targets.name] = [];
    }
    result[targets.name].push(targets.value);
  });
  Array.prototype.map.call(select, function(targets) {
    if (typeof(result[targets.name]) !== typeof([])) {
      result[targets.name] = [];
    }
    result[targets.name].push(targets.value);
  });
  Array.prototype.map.call(textarea, function(targets) {
    if (typeof(result[targets.name]) !== typeof([])) {
      result[targets.name] = [];
    }
    result[targets.name].push(targets.value);
  });
  var keys = Object.keys(result);
  if (flag === undefined) {
    flag = true;
  }

  if (keys.length > 0 && flag) {
    var cnt = result[keys[0]].length;
    // var keys = Object.keys(result);
    for (var i = 0; i < cnt; i++) {
      var array = {};
      for (var j = 0; j < keys.length; j++) {
        if (result[keys[j]][i]) {
          array[keys[j]] = result[keys[j]][i];
        } else {
          array[keys[j]] = null;
        }
      }
      arrayData.push(array);
    }
    return arrayData;
  } else {
    return result;
  }
};

// 달력 시작일 종료일 체크하기
global.utilCalendarBetween = function(start, end) {
  var result = false;

  if (start && end) {
    if (new Date(start).getTime() > new Date(end).getTime()) {
      result = true;
    }
  }
  return result;
};

// 아이디 정규식 체크
global.utilUserIdCheck = function(userId) {
  var result = false;
  var regType = /^[A-Za-z0-9+]{4,12}$/; // 영문 또는 숫자만 가능 4~12자리
  if (regType.test(userId)) {
    result = true;
  }
  return result;
};

// 패스워드 정규식 체크
global.utilPasswordCheck = function(password) {
  var result = false;
  var regType = /^.*(?=.{8,30})(?=.*[0-9])(?=.*[a-zA-Z]).*$/; // 8 ~ 30자리 영문+숫자혼합
  if (regType.test(password)) {
    result = true;
  }
  return result;
};

// 이메일 정규식 체크
global.utilEmailCheck = function(email) {
  var result = false;
  var regExp = /[0-9a-zA-Z][_0-9a-zA-Z-]*@[_0-9a-zA-Z-]+(\.[_0-9a-zA-Z-]+){1,2}$/;
  if (email.match(regExp)) {
    result = true;
  }
  return result;
};

// 암호화 & 복호화
global.utilAES = function(message, type) {
  var result = null;
  var password = '050812';
  var hashedPassword = CryptoJS.SHA256(password).toString();

  switch(type) {
    // 암호화
    case 'encrypt':
    var encrypt = CryptoJS.AES.encrypt(message, hashedPassword);
    // url의 '/'를 없애기 위한 base64로 변경이후 url에 표시
    var wordArray = CryptoJS.enc.Utf8.parse(encrypt);
    result = CryptoJS.enc.Base64.stringify(wordArray);
    break;
    // 복호화
    case 'decrypted':
    // base64를 복호화한뒤 message를 AES 256복호화 작업
    var parsedWordArray = CryptoJS.enc.Base64.parse(message);
    parsedWordArray = parsedWordArray.toString(CryptoJS.enc.Utf8);
    var decrypt = CryptoJS.AES.decrypt(parsedWordArray, hashedPassword);
    result = decrypt.toString(CryptoJS.enc.Utf8);
    break;
  }
  return result;
};

// 글씨 strong태그 추가
global.utilStrong = function(title) {
  var result = '';
  if (title) {
      result = '<strong>' + title + '</strong>';
  }
  return result;
};

export {global};
